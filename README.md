<p align="center">
<a  href="https://www.salesforce.com/"><img  src="https://a.sfdcstatic.com/shared/images/c360-nav/salesforce-with-type-logo.svg"  alt="Salesforce"  width="150" height="150" hspace="50" /></a>
<a  href="https://www.salesforce.com/data/"><img  src="https://cdn.vidyard.com/hubs/logos/60cb440e-ec9e-4786-9a95-85fdc45dcb89.png"  alt="Data Cloud"  width="150" height="150" hspace="50"/></a>
<a  href="https://www.salesforce.com/ca/agentforce/"><img  src="https://wp.salesforce.com/en-us/wp-content/uploads/sites/4/2024/09/img-agent-1.webp"  alt="Agentforce"  width="150" height="150" hspace="50"/></a>
<a  href="https://getstream.io/"><img  src="https://miro.medium.com/v2/resize:fit:2400/1*m-gTGzrcRxlkNF3gxGbgdQ.png"  alt="Get Stream IO"  width="150" height="150" hspace="50"/></a>
<a  href="https://developer.salesforce.com/docs/marketing/einstein-personalization/guide/overview.html"><img  src="https://www.salesforce.com/news/wp-content/uploads/sites/3/2023/03/Newsroom-Press-Release.png"  alt="Einstein Personalization"  width="150" height="150"  hspace="50"/></a>
<p/>

# Salesforce Personalization with Agentforce and a 3rd Party Chat Service

# Table of Contents

- [Salesforce Personalization with Agentforce and a 3rd Party Chat Service](#salesforce-personalization-with-agentforce-and-a-3rd-party-chat-service)
- [Table of Contents](#table-of-contents)
  - [What does it do?](#what-does-it-do)
  - [How does it work?](#how-does-it-work)
    - [Architecture diagram](#architecture-diagram)
      - [3rd Party Chat Architecture](#3rd-party-chat-architecture)
      - [Agentforce Architecture](#agentforce-architecture)
  - [Technologies used](#technologies-used)
- [Kudos](#kudos)
- [License](#license)
- [Disclaimer](#disclaimer)

---

ðŸš§**WORK IN PROGRESS**ðŸš§

## What does it do?

## How does it work?

### Architecture diagram

There are two separate use cases here:

1. Example of a 3rd party chat library [getstream.io](https://getstream.io/) with real-time Salesforce Personalization
2. Example of Salesforce Agentforce chat with real-time Salesforce Personalization

The architecture is slightly different and outlined bellow.

#### 3rd Party Chat Architecture

![](./screenshots/3rd-party-architecture-diagram.png)

The application flow is the following:

**Client**

1. The user navigates to the website URL
2. The browser sends a request to the hosting server, in this case that is a Heroku dyno
3. The Heroku returns HTML and Javascript, and Javascript hydrates the website
4. During the page load, the [Data Cloud Web SDK](https://developer.salesforce.com/docs/atlas.en-us.c360a_api.meta/c360a_api/c360a_api_salesforce_interactions_web_sdk.htm) also gets loaded into the website
5. Various web events get captured based on the [pre-defined web event JSON schema](./client/src/utils/data-cloud-schema.json) and custom react [useSalesforceInteractions.ts](./client/src/hooks/useSalesforceInteractions.ts) hook
6. The chat service used for this is a 3rd party library [getstream.io](https://getstream.io/)
7. As part of the website load, the chat service also gets [initialized](./client/src/components/ChatWidget/ChatCanvas.tsx)
8. Every chat message is captured by the custom [Data Cloud Web SDK event](./client/src/hooks/useSalesforceInteractions.ts#L16)
9. Additionally, on every captured chat message, a custom [notification service](./server/src/controllers/notification-service.js) endpoint gets invoked with a [deviceId](./client/src/utils/notifyAi.ts)
10. The `deviceId` is automatically generated by the Data Cloud Web SDK once the SDK is successfully loaded

**Server**

1. The web server is a [Node Express server](./server/index.js) hosted on Heroku
2. The web server uses the [Salesforce credentials](./server/.env.example) to retrieve the [authentication token](./server/src/utils/sfAuthToken.js) from Salesforce
3. With the retrieved token, a [Data Graph is invoked](./server/src/controllers/notification-service.js#23) based on the provided `deviceId`
4. The retrieved data from the Data Graph then gets [parsed](./server/src/utils/parseDataGraphData.js)
5. The parsed chat messages and the `deviceId` get send to the [Saleforce Flow via an API call](./server/src/controllers/notification-service.js#54)

**Salesforce Backend**

1. Salesforce Flow takes the provided chat messages and the `deviceId` from the API call
2. The Flow invokes a custom **Prompt**
3. The custom **Prompt** is instructed to deduce the product category based on the provided chat messages and the provided product catalog
4. Once the LLM deduces the product category, it will then return that in a specific format: `category,id`
5. The returned data gets passed back to the Salesforce Flow
6. Salesforce Flow takes the provided product category data and passes it off to a custom Apex class
7. The custom Apex class writes the data back to the Data Cloud's real-time Data Graph

**Client Personalization**

1. The client sends a message to the Salesforce Personalization endpoint via the [Data Cloud Web SDK](./client/src/hooks/useSalesforceInteractions.ts#196)
2. The Salesforce Personalization engine queries the real-time Data Graph for latest data
3. The Salesforce Personalization engine decides what the are appropriate product recommendations
4. The client receives the product recommendations from the Salesforce Personalization endpoint
5. Finally, the client makes the [changes on the web page](./client/src/components/Body/Recommendations.tsx)

#### Agentforce Architecture

![](./screenshots/agentforce-architecture-diagram.png)

The application flow is the following:

**Client**

1. The user navigates to the website URL
2. The browser sends a request to the hosting server, in this case that is a Heroku dyno
3. The Heroku returns HTML and Javascript, and Javascript hydrates the website
4. During the page load, the [Data Cloud Web SDK](https://developer.salesforce.com/docs/atlas.en-us.c360a_api.meta/c360a_api/c360a_api_salesforce_interactions_web_sdk.htm) also gets loaded into the website
5. Various web events get captured based on the [pre-defined web event JSON schema](./client/src/utils/data-cloud-schema.json) and custom react [useSalesforceInteractions.ts](./client/src/hooks/useSalesforceInteractions.ts) hook
6. As part of the website load, the Agentforce chat also gets [initialized](./client/src/hooks/useAgentforceScript.ts)
7. The `deviceId` is automatically generated by the Data Cloud Web SDK once the SDK is successfully loaded
8. The `deviceId` is then provided to the Agentforce chat on every sent message vie the [Prechat API](./client/src/hooks/useAgentforceScript.ts#36)

**Salesforce Backend**

1. The incoming chat message from the Agentforce chat is picked up by a Salesforce Agent
2. The Salesforce Agent has a dedicated Topic assigned to it
3. The assigned Topic has an Action that invokes a Salesforce Flow
4. Salesforce Flow takes the provided chat message and the `deviceId` from the Agent Action
5. The Flow invokes a custom **Prompt**
6. The custom **Prompt** is instructed to deduce the product category based on the provided chat message and the provided product catalog
7. Once the LLM deduces the product category, it will then return that in a specific format: `category,id`
8. The returned data gets passed back to the Salesforce Flow
9. Salesforce Flow takes the provided product category data and passes it off to a custom Apex class
10. The custom Apex class writes the data back to the Data Cloud's real-time Data Graph

**Client Personalization**

1. The client sends a message to the Salesforce Personalization endpoint via the [Data Cloud Web SDK](./client/src/hooks/useSalesforceInteractions.ts#196) once the Agentforce chatbot responds
2. The Salesforce Personalization engine queries the real-time Data Graph for latest data
3. The Salesforce Personalization engine decides what the are appropriate product recommendations
4. The client receives the product recommendations from the Salesforce Personalization endpoint
5. Finally, the client makes the [changes on the web page](./client/src/components/Body/Recommendations.tsx)

## Technologies used

**Client**

- [Vite](https://vitejs.dev/)
- [React](https://react.dev/)
- [TypeScript](https://www.typescriptlang.org/)
- [Zustand](https://github.com/pmndrs/zustand)
- [Chakra UI 3.0](https://www.chakra-ui.com/)
- [Data Cloud SDK](https://developer.salesforce.com/docs/atlas.en-us.c360a_api.meta/c360a_api/c360a_api_connect_data.htm)
- [getstream.io](https://getstream.io/)
- [Salesforce Embedded Chat](https://developer.salesforce.com/docs/atlas.en-us.snapins_web_dev.meta/snapins_web_dev/snapins_web_overview.htm)

**Server**

- [Node.js](https://nodejs.org/en)
- [Express](https://expressjs.com/)
- [JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript)
- [Heroku](https://www.heroku.com/)

**Salesforce**

- [Salesforce Data Cloud](https://www.salesforce.com/data/)
- [Data Cloud Data Graphs](https://help.salesforce.com/s/articleView?id=sf.c360_a_data_graphs.htm&type=5)
- [Salesforce Flows](https://help.salesforce.com/s/articleView?id=platform.flow.htm&type=5)
- [Apex](https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_intro_what_is_apex.htm)
- [Prompts](https://www.salesforce.com/artificial-intelligence/prompt-builder/)
- [Salesforce Personalization](https://help.salesforce.com/s/articleView?id=mktg.mc_persnl.htm&type=5)
- [Agentforce](https://www.salesforce.com/ca/agentforce/)

# Kudos

Special thank you to [Daniel Kuo](https://github.com/dkuosf) and [Anne Pizzini](https://github.com/annepizzi).

# License

[MIT](http://www.opensource.org/licenses/mit-license.html)

# Disclaimer

This software is to be considered "sample code", a Type B Deliverable, and is delivered "as-is" to the user. Salesforce bears no responsibility to support the use or implementation of this software.
